{% extends "base.html" %}

{% block title %}Healing Journal{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Journal Form -->
        <div class="lg:col-span-2">
            <div class="glass-card p-8 mb-8">
                <h2 class="text-2xl font-bold mb-6">How are you feeling today?</h2>

                <form method="POST" action="{{ url_for('journal') }}" class="space-y-6">
                    <!-- Mood Selector -->
                    <div>
                        <label class="block font-medium mb-3">Select your mood:</label>
                        <div class="flex space-x-4">
                            {% for mood in ['happy', 'neutral', 'sad', 'angry', 'anxious', 'hopeful'] %}
                            <label class="cursor-pointer">
                                <input type="radio" name="mood" value="{{ mood }}" class="hidden peer" {% if
                                    loop.index==3 %}checked{% endif %}>
                                <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl 
                                            bg-slate-100 text-slate-500 peer-checked:bg-rose-100 peer-checked:text-rose-600 
                                            hover:bg-rose-50 transition">
                                    <i class="fas fa-{{ 
                                        'smile' if mood == 'happy' else 
                                        'meh' if mood == 'neutral' else 
                                        'sad-tear' if mood == 'sad' else 
                                        'angry' if mood == 'angry' else 
                                        'heartbeat' if mood == 'anxious' else 
                                        'sun' 
                                    }}"></i>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Journal Text -->
                    <div>
                        <textarea name="content" rows="10" class="form-input auto-resize"
                            placeholder="Write about your thoughts, feelings, achievements, or challenges today..."></textarea>
                    </div>

                    <!-- Tags -->
                    <div>
                        <label class="block font-medium mb-3">Tags:</label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            {% for tag in ['Breakthrough', 'Memories', 'Self-Care', 'Growth', 'Anxiety', 'Gratitude'] %}
                            <button type="button"
                                class="tag-chip px-3 py-1 bg-slate-100 hover:bg-rose-100 hover:text-rose-600 rounded-full text-sm transition border border-slate-200"
                                onclick="addTag('{{ tag }}')">
                                <i class="fas fa-plus text-xs mr-1"></i> {{ tag }}
                            </button>
                            {% endfor %}
                        </div>
                        <input type="text" name="tags" id="tagsInput" class="form-input"
                            placeholder="Select tags above or type your own (comma separated)">
                    </div>

                    <!-- Submit & Analyze -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="button" onclick="healingApp.analyzeJournalEntry()"
                            class="btn-outline flex-1 py-3 bg-white hover:bg-purple-50 border-purple-200 text-purple-600">
                            <i class="fas fa-magic mr-2"></i> Analyze with AI
                        </button>
                        <button type="submit" class="btn-primary flex-1 py-3">
                            <i class="fas fa-save mr-2"></i> Save Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Journal Stats & Tips -->
        <div>
            <!-- Stats -->
            <div class="glass-card p-6 mb-6">
                <h3 class="text-lg font-bold mb-4">Journal Stats</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-600">Total Entries</span>
                            <span class="font-medium">{{ entries|length }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-600">Most Common Mood</span>
                            <span class="font-medium">Hopeful</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-600">Longest Streak</span>
                            <span class="font-medium">14 days</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Writing Prompts -->
            <div class="glass-card p-6">
                <h3 class="text-lg font-bold mb-4">Writing Prompts</h3>
                <div class="space-y-3">
                    <div class="p-3 bg-rose-50 rounded-lg cursor-pointer hover:bg-rose-100 transition">
                        <div class="font-medium text-slate-800">What made you smile today?</div>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg cursor-pointer hover:bg-purple-100 transition">
                        <div class="font-medium text-slate-800">What lesson did you learn recently?</div>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                        <div class="font-medium text-slate-800">Write a letter to your future self</div>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition">
                        <div class="font-medium text-slate-800">What are you grateful for today?</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Past Entries -->
    <div class="glass-card p-8">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold">Past Entries</h2>
            <button onclick="healingApp.exportJournal()"
                class="px-5 py-2.5 rounded-lg border-2 border-rose-100 text-rose-600 font-bold hover:bg-rose-50 transition-all flex items-center">
                <i class="fas fa-cloud-download-alt mr-2"></i> Export Journal
            </button>
        </div>

        {% if entries %}
        <div class="space-y-6">
            {% for entry in entries %}
            <div class="journal-entry p-6 rounded-xl border border-slate-100 hover:border-rose-200 transition"
                data-date="{{ entry.created_at }}" data-mood="{{ entry.mood }}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <div class="mood-{{ entry.mood }} w-10 h-10 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-{{ 
                                'smile' if entry.mood == 'happy' else 
                                'meh' if entry.mood == 'neutral' else 
                                'sad-tear' if entry.mood == 'sad' else 
                                'angry' if entry.mood == 'angry' else 
                                'heartbeat' if entry.mood == 'anxious' else 
                                'sun' 
                            }} text-white"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">{{ entry.created_at.strftime('%A, %B %d, %Y') }}</div>
                            <div class="text-slate-500">{{ entry.created_at.strftime('%I:%M %p') }}</div>
                        </div>
                    </div>
                    {% if entry.tags %}
                    <div class="flex flex-wrap gap-2">
                        {% for tag in entry.tags.split(',') %}
                        <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-sm">
                            {{ tag.strip() }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="text-slate-700 prose max-w-none">
                    {{ entry.content|replace('\n', '<br>')|safe }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-book text-5xl text-slate-300 mb-6"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-2">Your journal is empty</h3>
            <p class="text-slate-500 mb-6">Start writing to begin your healing journey</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function addTag(tag) {
        const input = document.getElementById('tagsInput');
        let currentVal = input.value;

        // Remove trailing commas and spaces
        currentVal = currentVal.replace(/,\s*$/, '');

        const currentTags = currentVal.split(',').map(s => s.trim()).filter(s => s);

        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            input.value = currentTags.join(', ');

            // Visual feedback
            const btn = event.currentTarget;
            btn.classList.add('bg-rose-100', 'text-rose-600', 'border-rose-200');
            setTimeout(() => {
                if (!input.value.includes(tag)) { // Only reset if removed (not really possible here but for effect)
                    // Keep highlighted? No, let's just flash it
                }
            }, 300);
        }
    }
</script>
{% endblock %}